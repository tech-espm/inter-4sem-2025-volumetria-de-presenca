{% extends 'layout.html' %}

{% block body %}

<style>
    canvas {
        background-color: white !important;
        border-radius: 12px;
    }

    .form-select {
        border-radius: 8px;
        padding: 4px 12px;
        display: inline-block;
        width: auto;
    }

    .card {
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .card-title {
        font-weight: 600;
    }
</style>

<div class="container py-5">
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <select id="seletor" class="form-select ms-2">
                        <option value="temperatura">Temperatura (°C)</option>
                        <option value="umidade">Umidade (%)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="date" id="dataInicial" class="form-control" value="{{ hoje }}">
                </div>
                <div class="col-md-3">
                    <input type="date" id="dataFinal" class="form-control" value="{{ hoje }}">
                </div>
                <div class="col-md-3">
                    <button id="btnFiltrar" class="btn btn-primary">Listar</button>
                </div>
            </div>
            <canvas id="graficoSensor" height="120"></canvas>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let chartSensor;

    const configCores = {
        temperatura: {
            cor: 'rgba(255, 99, 132, 1)',
            fundo: 'rgba(255, 99, 132, 0.3)',
            label: 'Temperatura (°C)',
            eixoY: '°C'
        },
        umidade: {
            cor: 'rgba(54, 162, 235, 1)',
            fundo: 'rgba(54, 162, 235, 0.3)',
            label: 'Umidade (%)',
            eixoY: '%'
        }
    };

    function formatarData(date) {
        return date.toISOString().split('T')[0];
    }

    function criarGrafico(tipo) {
        const dataInicial = document.getElementById('dataInicial').value;
        const dataFinal = document.getElementById('dataFinal').value;

        fetch(`/dados/temperatura?data_inicial=${dataInicial}&data_final=${dataFinal}`)
            .then(res => res.json())
            .then(dados => {
                if (!dados.length) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Sem dados disponíveis!',
                        text: 'Não há dados para exibição no momento.',
                        confirmButtonColor: '#3085d6'
                    });
                    if (chartSensor) chartSensor.destroy();
                    return;
                }

                const filtrado = dados.filter((_, index) => index % 6 === 0);
                const labels = filtrado.map(d => d.data);
                const valores = filtrado.map(d => d[tipo]);

                const { cor, fundo, label, eixoY } = configCores[tipo];

                if (chartSensor) chartSensor.destroy();

                const ctx = document.getElementById('graficoSensor').getContext('2d');
                chartSensor = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: valores,
                            borderColor: cor,
                            backgroundColor: fundo,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    boxWidth: 12,
                                    font: { weight: 'bold' }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Data e Hora'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: eixoY
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error("Erro ao carregar dados:", error);
                alert("Erro ao carregar dados do gráfico.");
            });
    }

    document.getElementById("btnFiltrar").addEventListener("click", function () {
        const tipo = document.getElementById("seletor").value;
        criarGrafico(tipo);
    });

    document.getElementById("seletor").addEventListener("change", function () {
        criarGrafico(this.value);
    });

    window.addEventListener("DOMContentLoaded", () => {
        const hoje = new Date();
        const seteDiasAtras = new Date();
        seteDiasAtras.setDate(hoje.getDate() - 7);

        document.getElementById("dataInicial").value = formatarData(seteDiasAtras);
        document.getElementById("dataFinal").value = formatarData(hoje);

        criarGrafico("temperatura");
    });


</script>


{% endblock %}